

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Export: ONNX &mdash; N2D2  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Export: other / legacy" href="legacy.html" />
    <link rel="prev" title="Export: DNeuro" href="DNeuro.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> N2D2
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/intro.html">Presentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/about.html">About N2D2-IP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/simus.html">Performing simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/perfs_tools.html">Performance evaluation tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/tuto.html">Tutorials</a></li>
</ul>
<p class="caption"><span class="caption-text">ONNX Import:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../onnx/convert.html">Obtain ONNX models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onnx/import.html">Import ONNX models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onnx/transfer.html">Train from ONNX models</a></li>
</ul>
<p class="caption"><span class="caption-text">Quantization and Export:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quant/post.html">Post-training quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quant/qat.html">[NEW] Quantization-Aware Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="CPP.html">Export: C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="CPP_STM32.html">Export: C++/STM32</a></li>
<li class="toctree-l1"><a class="reference internal" href="TensorRT.html">Export: TensorRT</a></li>
<li class="toctree-l1"><a class="reference internal" href="DNeuro.html">Export: DNeuro</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Export: ONNX</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#principle">Principle</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#graph-optimizations">Graph optimizations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#export-parameters">Export parameters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="legacy.html">Export: other / legacy</a></li>
</ul>
<p class="caption"><span class="caption-text">INI File Interface:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ini/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ini/databases.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ini/data_analysis.html">Stimuli data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ini/environment.html">Stimuli provider (Environment)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ini/layers.html">Network Layers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ini/target.html">Targets (outputs &amp; losses)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adversarial.html">Adversarial module</a></li>
</ul>
<p class="caption"><span class="caption-text">Python API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_api/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_api/databases.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_api/cells.html">Cells</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_api/tensor.html">Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_api/interoperability.html">Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_api/export.html">Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_api/example.html">Example</a></li>
</ul>
<p class="caption"><span class="caption-text">C++/Python core:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../core/core.html">Core N2D2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core/example.html">Example</a></li>
</ul>
<p class="caption"><span class="caption-text">C++ API / Developer:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev_intro.html">Introduction</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">N2D2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Export: ONNX</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/export/ONNX.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="export-onnx">
<span id="export-onnx-label"></span><h1>Export: ONNX<a class="headerlink" href="#export-onnx" title="Permalink to this headline">¶</a></h1>
<dl class="simple">
<dt>Export type: <code class="docutils literal notranslate"><span class="pre">ONNX</span></code></dt><dd><p>ONNX export.</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n2d2</span> <span class="n">MobileNet_ONNX</span><span class="o">.</span><span class="n">ini</span> <span class="o">-</span><span class="n">seed</span> <span class="mi">1</span> <span class="o">-</span><span class="n">w</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">export</span> <span class="n">ONNX</span>
</pre></div>
</div>
<div class="section" id="principle">
<h2>Principle<a class="headerlink" href="#principle" title="Permalink to this headline">¶</a></h2>
<p>The ONNX export allows you to generate an ONNX model from a N2D2 model. The
generated ONNX model is optimized for inference and can be quantized beforehand
with either post-training quantization or Quantization Aware Training (QAT).</p>
<div class="section" id="graph-optimizations">
<h3>Graph optimizations<a class="headerlink" href="#graph-optimizations" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Weights are equalized between layers when possible;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BatchNorm</span></code> is automatically fused with the preceding <code class="docutils literal notranslate"><span class="pre">Conv</span></code> or <code class="docutils literal notranslate"><span class="pre">Fc</span></code> when possible;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Padding</span></code> layers are fused with <code class="docutils literal notranslate"><span class="pre">Conv</span></code> when possible;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Dropout</span></code> layers are removed.</p></li>
</ul>
</div>
<div class="section" id="export-parameters">
<h3>Export parameters<a class="headerlink" href="#export-parameters" title="Permalink to this headline">¶</a></h3>
<p>Extra parameters can be passed during export using the
<code class="docutils literal notranslate"><span class="pre">-export-parameters</span> <span class="pre">params.ini</span></code> command line argument. The parameters must be
saved in an INI-like file.</p>
<p>List of available parameters:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Argument [default value]</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ImplicitCasting</span></code> [0]</p></td>
<td><p>If true (1), casting in the graph is implicit and <code class="docutils literal notranslate"><span class="pre">Cast</span></code> ONNX operators are not inserted</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">FakeQuantization</span></code> [0]</p></td>
<td><p>If true (1), the graph is fake quantized, meaning floating-point ONNX operators are used for the computation</p></td>
</tr>
</tbody>
</table>
<p>The parameters <code class="docutils literal notranslate"><span class="pre">ImplicitCasting</span></code> and <code class="docutils literal notranslate"><span class="pre">FakeQuantization</span></code> are useful only for
quantized networks. In this case, a full integer ONNX graph is generated when
possible, notably using the ONNX <em>ConvInteger</em> and <em>MatMulInteger</em> when
<code class="docutils literal notranslate"><span class="pre">-nbbits</span></code> is ≤ 8 bits. An example of generated graph is shown below, with a
<code class="docutils literal notranslate"><span class="pre">Single-shift</span></code> activation rescaling mode (<code class="docutils literal notranslate"><span class="pre">-act-rescaling-mode</span></code>, see
<a class="reference internal" href="../quant/post.html#post-quant-label"><span class="std std-ref">Post-training quantization</span></a>):</p>
<div class="figure align-center">
<img alt="Example of fully integer, quantized, exported ONNX graph." src="../_images/export_ONNX_quant.svg" /></div>
<p>By default, strict adherence to the ONNX standard is enforced, by adding
explicit <code class="docutils literal notranslate"><span class="pre">Cast</span></code> operators when required. The automatic insertion of <code class="docutils literal notranslate"><span class="pre">Cast</span></code>
operators can be disabled by setting the <code class="docutils literal notranslate"><span class="pre">ImplicitCasting</span></code> export parameter
to true. This results in the simplified graph below:</p>
<div class="figure align-center">
<img alt="Example of fully integer, quantized, exported ONNX graph without ``Cast`` operators (with ``ImplicitCasting`` set to 1)." src="../_images/export_ONNX_quant_implicit_cast.svg" /></div>
<p>The <code class="docutils literal notranslate"><span class="pre">FakeQuantization</span></code> parameter allows to export a quantized network using
fake quantization, meaning the parameters of the network are quantized (integer)
but their representation remains in floating-point and the computation is done
with floating-point operators. However, the output values of the network
should be almost identical to when the computation is done in integer. The
differences are due to numerical errors as all integers cannot be represented
exactly with floating-point.</p>
<div class="figure align-center">
<img alt="Example of fully integer, quantized, exported ONNX graph with fake quantization (``FakeQuantization`` set to 1)." src="../_images/export_ONNX_quant_fake.svg" /></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">FakeQuantization</span></code>, when set, implies <code class="docutils literal notranslate"><span class="pre">ImplicitCasting</span></code>, as no
casting operator is required in a fully floating-point graph.</p>
</div>
</div>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n2d2</span> <span class="n">MobileNet_ONNX</span><span class="o">.</span><span class="n">ini</span> <span class="o">-</span><span class="n">seed</span> <span class="mi">1</span> <span class="o">-</span><span class="n">w</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">-</span><span class="n">export</span> <span class="n">ONNX</span> <span class="o">-</span><span class="n">nbbits</span> <span class="mi">8</span> <span class="o">-</span><span class="n">calib</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">export</span> <span class="mi">100</span> <span class="o">-</span><span class="n">test</span>
</pre></div>
</div>
<p>This command generates a 8-bits integer quantized ONNX model in the sub-directory
<code class="docutils literal notranslate"><span class="pre">export_ONNX_int8</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="legacy.html" class="btn btn-neutral float-right" title="Export: other / legacy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="DNeuro.html" class="btn btn-neutral float-left" title="Export: DNeuro" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, CEA LIST

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>